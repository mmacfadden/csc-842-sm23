Config.OperateStorage=function(r){var l,a=null,t=!1,o={Addr:["Address","Addr"],Port:["Address","Port"],Path:["Path"],UserName:["UserName"]},n=["mainVideoStream","roleVideoStream","thirdVideoStream"],s={},p={},d={},c="SDStorage",m={},S={StorType:["StorageResource","StorageType"],TotalMemory:["StorageResource","MemInfos",0,"TotalMemory"],SpareMemory:["StorageResource","MemInfos",0,"SpareMemory"],RecAllocMem:["VideoStorage","AllocMemory"],RecStorMode:["VideoStorage","StorageMode"],RecManualStreamID:["VideoStorage","ManualStreamID"],RecPlanStreamID:["VideoStorage","PlanStreamID"],RecStorPolicy:["VideoStorage","StoragePolicy"],PicAllocMem:["PhotoStorage","AllocMemory"],PicSpareMemory:["PhotoStorage","SpareMemory"],PicCurrentFileNum:["PhotoStorage","CurrentFileNumber"],PicSpareFileNum:["PhotoStorage","SpareFileNumber"],PicStorMode:["PhotoStorage","StorageMode"],PicStorPolicy:["PhotoStorage","StoragePolicy"],IPCPicAllocMem:["IPCPhotoStorage","AllocMemory"]};Capinfo.isSupportFishEye&&(n=["roleVideoStream","streamID7","streamID3","streamID4","streamID5","streamID6"]);var i=null;Capinfo.isSupportPersonPhoto||Capinfo.isSupportFaceDetection||Capinfo.isSupportFaceQualityPro;return new(Class.extend({isFirstConnect:!0,init:function(){Utils.beforeDataLoad(),this.initPage(),Utils.initLang(),this.initEvent(),this.initData(),this.initValidator(),Utils.afterDataLoad()},initPage:function(){this.initStorTypeOption(),Capinfo.isSupportJPEG&&r("#ManualStreamIDP").addClass("hidden"),!Capinfo.isSupportTrafficFlow&&Capinfo.isSupportJPEG||r("#picStorageField").addClass("hidden"),Capinfo.isSupportBasicFTP||Capinfo.isSupportJPEG||r("#capacityAssignment").addClass("hidden"),Capinfo.isSupportRecordPlayback&&(r("#planStorage_enable_span").removeClass("hidden"),r("#planDiv").removeClass("hidden")),Capinfo.isSupportCapture&&IVAMode.ILLEGAL!=Frame.IVAType||r("#AlarmPastTime").removeClass("hidden"),Capinfo.isSupportCapture||(r("#photoCapacity").removeClass("hidden"),Capinfo.isSupportProfessionalFace||Capinfo.isSupportsystemSetUpLink?(r("#illphotoCapacity").removeClass("hidden"),r("#IPCstoreSpaceTip").removeClass("hidden")):r("#IPCPicAllocMem").prop("disabled",!0))},initData:function(){var e,a,t,o={},i=[r.lang.pub.noexist,r.lang.pub.fault,r.lang.pub.noinitial,r.lang.pub.normal];if(d={},l={},m={},Utils.LAPI_GetCfgData(LAPI_URL.LAPI_SD,l)&&(3!=(t=l.StatusParam.SDStatus)&&(Utils.disableAll(),1!=t&&2!=t||(Frame.showMsg(!1,r.lang.tip.tipSDCardAbnormal),r("#SDCardAbnormal").removeClass("hidden"))),0!=t&&r("#formatBtn").prop("disabled",!1),r("#SDStatus").html([i[t]])),Utils.LAPI_GetCfgData(LAPI_URL.Storage,m))if(1<m.StorageResource.Nums&&(r("#SDCard1Label").removeClass("hidden"),r("#SD2Info").removeClass("hidden"),r("#capacityAssignment").children("legend").text(r.lang.pub.SDCard1Memory),S.TotalMemory2=["StorageResource","MemInfos",1,"TotalMemory"],S.SpareMemory2=["StorageResource","MemInfos",1,"SpareMemory"]),Utils.changeMapToMapByMapping(m,S,d,0),Capinfo.isSupportProfessionalFace&&r("#PicAllocMem").val(d.TotalMemory-d.RecAllocMem-d.IPCPicAllocMem),isOldPlugin&&!Capinfo.isMac&&1==d.StorType&&Utils.LAPI_GetCfgData(LAPI_URL.STOR_NAS_CFG,p,"",!0,this.callback),Utils.LAPI_GetCfgData(LAPI_URL.VideoEncode,o)){for(e=0,a=Number(o.Num);e<a&&(Capinfo.isSupportFishEye||2!=e);e++){if(Capinfo.isSupport4KFishEye){e=1,r("#RecManualStreamID,#RecPlanStreamID").append("<option value="+e+">"+r.lang.pub[n[e]]+"</option>");break}if(0==o.VideoStreamInfos[e].Enabled)break;r("#RecManualStreamID,#RecPlanStreamID").append("<option value="+e+">"+r.lang.pub[n[e]]+"</option>")}if(Capinfo.isSupportRecordPlayback&&(Plan.init(LAPI_URL.WeekPlan+c,r.lang.pub.StoragePlan),r("#PlanEnable").addClass("hidden"),1!=planMap.PlanEnable&&r("#planDiv").addClass("hidden")),10==d.RecStorMode?d.StorageMode=0:11==d.RecStorMode&&(1==planMap.PlanEnable?d.StorageMode=1:d.StorageMode=2),!Capinfo.isSupportCapture||IVAMode.ILLEGAL==Frame.IVAType){if(!Utils.LAPI_GetCfgData(LAPI_URL.AlarmStorage,d))return void Utils.disableAll();if(!Utils.LAPI_GetCfgData(LAPI_URL.SDCardSwitch,s))return void Utils.disableAll()}Utils.LAPI_CfgToForm("frmSetup",s),Utils.cfgToForm(d,"frmSetup"),Utils.setLabelValue(d),r("#RecAllocMem").attr("maxLength",d.TotalMemory.length),r("#IPCPicAllocMem").attr("maxLength",d.TotalMemory.length),this.StorType_change(),Capinfo.isSupport4KFishEye&&r("#RecManualStreamID,#RecPlanStreamID").prop("disabled",!0),Capinfo.isSupportCapture&&IVAMode.ILLEGAL!=Frame.IVAType||1==s.SDCardEnable||(Utils.disableAll(),r("#SDCardEnable").prop("disabled",!1)),this.Storagehiddenshow()}else Utils.disableAll();else Utils.disableAll()},initEvent:function(){var e=this;r("#SDCardEnable").bind("click",function(){return!!confirm(r.lang.tip.tipChangeSDcardEnable)&&(Utils.LAPI_FormToCfg("frmSetup",s),void(Utils.LAPI_SetCfgData(LAPI_URL.SDCardSwitch,s)&&(Utils.disableAll(),Frame.PageBlockType=BlockType.REBOOT,Frame.updateBlock(!0,r.lang.tip.tipRebooting))))}),r("#StorType").change(function(){return confirm(r.lang.tip.tipChangeStorType)?(t=!0,void(e.submitF()&&(e.StorType_change(),Utils.disableAll()))):(r("#StorType").val(d.StorType),!1)}),r("#formatBtn").bind("click",function(){confirm(r.lang.tip.tipConfirmFormat)&&Utils.LAPI_SetCfgData(LAPI_URL.SDFormat,"",!1,Config.OperateStorage.SDStatusCallBack)}),r("#connect").bind("click",function(){e.connectNAS()}),r("input[name='StorageMode']").bind("click",function(){e.Storagehiddenshow()})},submitF:function(){var e;if(a.form()){if(Capinfo.isSupportRecordPlayback){if(!Plan.IsChanged()&&!Utils.IsChanged("frmSetup",d))return!1}else if(!Utils.IsChanged("frmSetup",d))return!1;if(r("#RecAllocMem").val()!=d.RecAllocMem||r("#IPCPicAllocMem").val()!=d.IPCPicAllocMem){if(!confirm(r.lang.tip.tipChangeUploadSpace))return!1;t=!0}return!Capinfo.isSupportRecordPlayback||(storType=Number(r("#StorType").val()),e=Plan.submitF(LAPI_URL.WeekPlan+c))?(Utils.LAPI_FormToCfg("frmSetup",m,d,S),Capinfo.isSupportCapture&&IVAMode.ILLEGAL!=Frame.IVAType||Utils.LAPI_SetCfgData(LAPI_URL.AlarmStorage,d)?((e=Utils.LAPI_SetCfgData(LAPI_URL.Storage,m))?t&&(Frame.PageBlockType=BlockType.REBOOT,Frame.updateBlock(!0,r.lang.tip.tipRebooting),t=!1):Utils.cfgToForm(d,"frmSetup"),e):void 0):(Frame.showMsg(!1),!1)}},release:function(){i&&clearTimeout(i),Frame.hiddenVideo(),Frame.currentNameSpace="",delete Config.OperateStorage},initValidator:function(){var e=Number(d.TotalMemory);r("#RecAllocMem").attr("tip",r.validator.format(r.lang.tip.tipIntRange,0,e)),r("#IPCPicAllocMem").attr("tip",r.validator.format(r.lang.tip.tipIntRange,0,e)),r("#PastTime").attr("tip",r.validator.format(r.lang.tip.tipIntRange,30,1800)),(a=r("#frmSetup").validate({focusInvalid:!1,errorElement:"span",errorPlacement:function(e,a){Utils.showJqueryErr(e,a,"div")},success:function(){},rules:{RecAllocMem:{integer:!0,required:!0,range:[0,e]},IPCPicAllocMem:{integer:!0,required:!0,range:[0,e]},PastTime:{integer:!0,required:!0,range:[30,1800]}}})).init()},initStorTypeOption:function(){for(var e=Capinfo.storTypeArr,a="",t=0;t<e.length;t++)switch(Number(e[t])){case 0:a+="<option value='0' lang='memoryCard'></option>";break;case 1:a+="<option value='1' lang='NAS'></option>"}r("#StorType").append(a)},StorType_change:function(){1==r("#StorType").val()?(r("#formatspan").addClass("hidden"),r("#formatBtn").addClass("hidden"),r("#pathDL").removeClass("hidden"),r("#enableSDCard").addClass("hidden")):(r("#formatspan").removeClass("hidden"),r("#formatBtn").removeClass("hidden"),r("#pathDL").addClass("hidden"),Capinfo.isSupportCapture||r("#enableSDCard").removeClass("hidden"))},valueChange:function(e){var a=r("#"+e),t=r("#PicAllocMem");Capinfo.isSupportProfessionalFace||Capinfo.isSupportsystemSetUpLink?(e=d.TotalMemory-r("#RecAllocMem").val()-r("#IPCPicAllocMem").val())<0?(alert(r.lang.tip.tipUpTotalStorage),a.val(a[0].getAttribute("defaultValue"))):(t.val(e),t[0].setAttribute("defaultValue",e),a[0].setAttribute("defaultValue",a.val())):(Capinfo.isSupportCapture?t:r("#IPCPicAllocMem")).val(d.TotalMemory-r("#RecAllocMem").val())},connectNAS:function(){Utils.openWin(r.lang.pub.NASWinTitle,"/page/common/nas_info.9c49a29e.htm",400,150,!1)},SDStatusCallBack:function(e){0==e?Frame.updateBlock(!0,r.lang.tip.tipFormating):561==e?alert(r.lang.tip.tipFormatFailedReboot):560==e?alert(r.lang.tip.tipFormatFailedChange):alert(r.lang.tip.tipFormatFailed)},eventMemoryCardFormat:function(e){var a=r.lang.tip.tipFormatSuccess,e=parseInt(e),e=ResultCode.RESULT_CODE_SUCCEED==e;e?(Frame.PageBlockType=BlockType.REBOOT,r("#statusInfo").text(r.lang.tip.tipRebooting)):(Frame.updateBlock(!1),a=r.lang.tip.tipFormatFailed),Frame.showMsg(e,a),i=setTimeout(function(){Frame.autoLogin()},5e3)},eventConnectNAS:function(e){var a=r.lang.tip.tipConnectFailed;Frame.updateBlock(!1),top.showedFlag=!0,e=parseInt(e);var t=r("#NASPath");e?(""!=t.text()&&t.text(""),this.isFirstConnect&&(this.isFirstConnect=!1,Utils.eventAlert(a))):t.text(d.Addr+d.Path)},callback:function(e){ResultCode.RESULT_CODE_SUCCEED==e||ResultCode.RESULT_CODE_NOT_MOUNT==e?ResultCode.RESULT_CODE_NOT_MOUNT==e?(Utils.sdkAddCfg(d,"Addr=0.0.0.0&Port=0&Path=\\&UserName=&Password="),(p={Address:{}}).Address.Addr=d.Addr,p.Address.Port=d.Port,p.Path=d.Path,p.UserName=d.UserName,p.RSAPublicKey={},p.RSAPublicKey.RSAPublicKeyE=Frame.RSAPublicKeyE,p.RSAPublicKey.RSAPublicKeyN=Frame.RSAPublicKeyN,p.Password=Utils.encrypting(d.Password,Frame.RSAKey),Frame.updateBlock(!0),top.showedFlag=!1):(Utils.changeMapToMapByMapping(p,o,d,0),r("#NASPath").text(d.Addr+d.Path)):Frame.showMsg(!1,r.lang.tip.tipGetCfgFail)},Storagehiddenshow:function(){r("#manualStorage_enable").is(":checked")?(r("#PlanEnable").prop("checked",!1),r("#RecStorMode").val(10),r("#planDiv").addClass("hidden"),r("#ManualStreamIDP").removeClass("hidden"),r("#PlanStreamIDIDP").addClass("hidden"),r("#VideoStorPolicyP").removeClass("hidden"),Capinfo.isSupportCapture&&IVAMode.ILLEGAL!=Frame.IVAType||r("#AlarmPastTime").removeClass("hidden")):r("#planStorage_enable").is(":checked")?(r("#planDiv").removeClass("hidden"),r("#PlanEnable").prop("checked",!0),r("#RecStorMode").val(11),r("#PlanStreamIDIDP").removeClass("hidden"),r("#ManualStreamIDP").addClass("hidden"),r("#VideoStorPolicyP").removeClass("hidden"),Capinfo.isSupportCapture&&IVAMode.ILLEGAL!=Frame.IVAType||r("#AlarmPastTime").removeClass("hidden")):r("#manualStorage_close").is(":checked")&&(r("#PlanEnable").prop("checked",!1),r("#RecStorMode").val(11),r("#planDiv").addClass("hidden"),r("#ManualStreamIDP,#PlanStreamIDIDP,#VideoStorPolicyP").addClass("hidden"))}}))}(jQuery),Frame.currentNameSpace=Config.OperateStorage;