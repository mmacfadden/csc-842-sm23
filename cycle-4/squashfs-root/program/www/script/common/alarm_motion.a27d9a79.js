Config.alarmMotion=function(s){var o=null,m=null,l={},d={MotionAreaLinkEnable:["Enable"],MotionAreaLinkTime:["ReturnTime"]},u=[],f=0,c=0,h=DrawType.RECT,n=!0,g=0,p=0,L=25,A=Capinfo.motionAreaNum,t=s("#menu").width(),v=["CC66FF","FF6633","0099FF","339933","CC0033","6666CC","FFFF66","99CC00"],a=["switchOutLi","presetLi","ftpLi","emailLi","storLi","picLi"],T={},b={},I={},C={},M={},D={},U={},P={},S={},_={},k={},y={},r={Sensitivity:{sliderId:"SensitivitySld",barId:"SensitivityBar",minValue:1,maxValue:100,sld:null},TargetSize:{sliderId:"TargetSizeSld",barId:"TargetSizeBar",minValue:1,maxValue:100,sld:null}};return new(Class.extend({menuTop:s(".fixLine").offset().top,init:function(){LoginType.VM_LOGIN!=Frame.loginType&&Utils.loadHtml("smartLinkOutIFrameDiv","/page/common/smart_linkout.76e56953.htm"),Utils.beforeDataLoad(),Utils.initLang(),this.initPage(),this.initValidator(),this.initEvent(),this.initData(),Utils.initVideo("recordManager_div_activeX",StreamType.LIVE,RunMode.CONFIG,null,Capinfo.isSupportPTZ,this.initVideo_callback),Utils.afterDataLoad()},initPage:function(){LoginType.VM_LOGIN!=Frame.loginType&&smartLinkOutIframe.initPage(a);var e=s(".fixLine");LoginType.VM_LOGIN==Frame.loginType?(e.css("left",35),e.css("top",0)):e.css("left",t+35);var i,e=s("#recordManager_div_activeX");for(i in Utils.resetVideoSize(Frame.DefaultStreamID,"recordManager_div_activeX"),e.height(18*Math.ceil(e.height()/18)),s("#add").attr("title",s.lang.pub.add),LoginType.VM_LOGIN==Frame.loginType&&((e=s("#videoDiv")).css("float","left"),s("#linkOutIFrame").addClass("hidden"),s("#planDiv").addClass("hidden"),s("#contentDiv").css({margin:"0 0 0 15px"}),e.css("marginLeft","5px"),s("#submitBtn").remove()),this.initSlider(),r)this.setSliderEnable(i,!0),this.setSliderValue();for(Capinfo.isSupportMotionLinkPreset&&(s("#presetTR").addClass("hidden"),s("#MotionLinkPresetDIV").removeClass("hidden"),s("#MotionAreaLinkEnableDIV").removeClass("hidden")),i=1;i<300;i++)s("#alarmView").append("<div class='activity' style='height: 0px;margin-top: 100px;background-color: black'></div>");IVAMode.ILLEGAL==Frame.IVAType&&Capinfo.isSupportIntelligentTI&&s("#detecModeDIV").addClass("hidden"),this.generalPresetOption()},initData:function(){if(Utils.LAPI_GetCfgData(LAPI_URL.MotionDetectType,U)&&Utils.LAPI_GetCfgData(LAPI_URL.MotionDetect,I)&&Utils.LAPI_GetCfgData(LAPI_URL.MotionDiamondDetect,S)&&Utils.LAPI_GetCfgData(LAPI_URL.MotionInterval,M)){if(P=Utils.objectClone(U),C=Utils.objectClone(I),_=Utils.objectClone(S),D=Utils.objectClone(M),Utils.LAPI_CfgToForm("frmSetup",U),Utils.LAPI_CfgToForm("frmSetup",M),c=U.Type,A=I.Num,s("#MotionAreaLinkEnable").is(":visible")){if(!Utils.LAPI_GetCfgData(LAPI_URL.MotionAreaLinkPre,k))return Utils.disableAll(),!1;y=Utils.objectClone(k),Utils.LAPI_CfgToForm("frmSetup",k,l,d)}this.initAreaList(),LoginType.VM_LOGIN!=Frame.loginType&&(smartLinkOutIframe.initData(LAPI_URL.MotionDetectLink)||(Utils.disableAll(),Frame.showMsg(!1,s.lang.tip.tipGetCfgFail)),Plan.init(LAPI_URL.WeekPlan+"MotionDetect")),this.detectType_change()}else Utils.disableAll()},initEvent:function(){var e=this;LoginType.VM_LOGIN==Frame.loginType&&(s("#IntervalTime").change(function(){e.submitF(!1)}),s("#Dejitter").change(function(){e.submitF(!1)})),s("#Type").change(function(){e.detectType_change(),o.init(),e.submitF(!0)}),s("#MotionPresetNum").change(function(){e.changeMotionDetectArea()})},submitF:function(e){var i=!1,t=!1;if(e)Utils.LAPI_FormToCfg("frmSetup",U),(t=!Utils.isObjectEquals(U,P))&&(i=Utils.LAPI_SetCfgData(LAPI_URL.MotionDetectType,U))&&(P=Utils.objectClone(U)),0==c?(Utils.LAPI_FormToCfg("frmSetup",I.RectangleAreas[m]),(t=!Utils.isObjectEquals(I,C))&&(i=Utils.LAPI_SetCfgData(LAPI_URL.MotionDetect,I))&&(C=Utils.objectClone(I))):(Utils.LAPI_FormToCfg("frmSetup",S),(t=!Utils.isObjectEquals(S,_))&&(i=Utils.LAPI_SetCfgData(LAPI_URL.MotionDiamondDetect,S))&&(_=Utils.objectClone(S)));else{if(s("#MotionAreaLinkEnableDIV").is(":visible")){var a=!1,n=Number(s("#MotionAreaLinkEnable").is(":checked")),r=s("#MotionAreaLinkTime").val();if(l.MotionAreaLinkEnable!=n||l.MotionAreaLinkTime!=r){if(!o.form())return;Utils.LAPI_FormToCfg("frmSetup",k,l,d),(a=!Utils.isObjectEquals(k,y))&&(i=Utils.LAPI_SetCfgData(LAPI_URL.MotionAreaLinkPre,k))&&(y=Utils.objectClone(k))}T.AlarmParam1!=s("#MotionPresetNum").val()&&(T.AlarmParam1=s("#MotionPresetNum").val(),T.AlarmParam1,s("#MotionPresetNum").val(),AlarmType.MOTION_DETECT_AREA1)}if(!o.form())return;if(Utils.LAPI_FormToCfg("frmSetup",M),(t=!Utils.isObjectEquals(M,D))&&(i=Utils.LAPI_SetCfgData(LAPI_URL.MotionInterval,M))&&(D=Utils.objectClone(M)),LoginType.VM_LOGIN!=Frame.loginType){n=smartLinkOutIframe.IsChanged(),r=Plan.IsChanged();if(!(t||n||r||a))return void Frame.showMsg(!0,s.lang.tip.tipAnyChangeInfo,0);r&&(i=Plan.submitF(LAPI_URL.WeekPlan+"MotionDetect")),n&&(i=smartLinkOutIframe.submitF(LAPI_URL.MotionDetectLink))}}return i},release:function(){this.clearTimeId(p),this.clearTimeId(g),Utils.EnableDrawFun(StreamType.LIVE,0),Frame.hiddenVideo(),delete Config.alarmMotion},initSlider:function(){var e,i=this;for(e in r){var t=r[e],a=new Slider(t.sliderId,t.barId,{onMove:function(){n&&s("#"+this.textId).val(Math.round(this.GetValue())),0==c&&"TargetSize"==this.textId&&s("hr[class='sizeline']").css("marginTop",101-Math.round(this.GetValue()))},onDragStop:function(){i.submitF(!0)},showTip:!0});a.textId=e,a.MinValue=t.minValue,a.MaxValue=t.maxValue,t.sld=a}},setSliderValue:function(){for(var e in r)n=!1,r[e].sld.SetValue(Number(s("#"+e).val())),n=!0},setSliderEnable:function(e,i){var t=r[e].sliderId,a=r[e].barId;i?(s("#"+t).removeClass().addClass("slider4"),s("#"+a).removeClass().addClass("bar3 bar4")):(s("#"+t).removeClass().addClass("slider3"),s("#"+a).removeClass().addClass("bar3")),r[e].sld.setEnable(!i),s("#"+e).prop("disabled",i)},packbits:function(e){for(var i,t,a=[],n=0,r=0,o=e.length,l=0,s=0;0<o;l=i,o-=r)if(t=o<128?o:128,3<=o&&e[l+1]==e[l]&&e[l+2]==e[l]){for(i=l+3,n=3;n<t&&e[i]==e[l];n++)++i;a[s++]=257-(r=n),a[s++]=e[l]}else{for(i=l,n=0;n<t&&!(n+3<=o&&e[i+1]==e[i]&&e[i+2]==e[i]);n++)++i;a[s++]=(r=n)-1,a=a.concat(e.slice(l,l+r)),s+=r}return a},unpackbits:function(e){for(var i,t,a,n=[],r=e.length,o=0;1<r;)if(--r,128!=(t=e[o++]))if(128<t)for(t=257-t,a=e[o++],--r,i=0;i<t;i++)n.push(a);else{if(r<++t)break;n=n.concat(e.slice(o,o+t)),o+=t,r-=t}return n},strToNumArr:function(e){var i,t=e.length%8,a=[];if(0!=t)for(t=8-t,i=0;i<t;i++)e+="0";for(t=e.length;0<t;t-=8)a.push(parseInt(e.substr(0,8),2)),e=e.substring(8);return a},numArrToStr:function(e){for(var i,t,a,n=e.length,r="",o=0;o<n;o++){for(a=8-(t=parseInt(e[o]).toString(2)).length,i=0;i<a;i++)r+="0";r+=t}return r},encodeData:function(e){for(var i="",t=e,t=isOldPlugin&&!Capinfo.isMac?this.strToNumArr(e):e,a=0,n=(t=this.packbits(t)).length;a<n;a++)i+=String.fromCharCode(t[a]);return isOldPlugin&&!Capinfo.isMac?this.numArrToStr(t):Utils.base64encode(i)},decodeData:function(e){for(var i=[],t=0,a=(e=Utils.base64decode(e)).length;t<a;t++)i.push(e.charCodeAt(t));return i=this.unpackbits(i)},clickMotionAreaLink:function(){for(var e=!0,i=0;i<A;i++)if(!s("#areaTR"+i).is(":hidden")){e=!1;break}s("#MotionAreaLinkEnable").is(":checked")?(s("#MotionAreaLinkTime").prop("disabled",!1),s("#linkOutIFrame").find("li").prop("disabled",!0),s("#MotionPresetNum").prop("disabled",e)):(s("#MotionAreaLinkTime").prop("disabled",!0),s("#linkOutIFrame").find("li").prop("disabled",!1),s("#MotionPresetNum").prop("disabled",!0))},selectArea:function(e){null!=m&&(s("#areaTR"+m).removeClass("selectedTR"),s("#selectDiv"+m).removeClass("selectedDiv")),s("#areaTR"+(m=e)).addClass("selectedTR"),s("#selectDiv"+m).addClass("selectedDiv"),Utils.selectDrawObj(h,m),this.getMotionAreaLinkCfg(),this.showAreaInfo()},getMotionAreaLinkCfg:function(){if(s("#MotionAreaLinkEnable").is(":visible")){if(!Utils.LAPI_GetCfgData(LAPI_URL.MotionDetectLink,T))return Utils.disableAll(),!1;var e=0<T.ActNum?T.AlarmParam1:-1;s("#MotionPresetNum").val(e)}},changeMotionDetectArea:function(){this.submitF(!1)},clearTimeId:function(e){e&&(clearInterval(e),e==g?g=0:p=0)},showAreaInfo:function(){var e,c=this;for(e in s("#areaName").html(m+1),Utils.LAPI_CfgToForm("frmSetup",I.RectangleAreas[m]),r)this.setSliderEnable(e,!1);this.setSliderValue(),this.clearTimeId(p),this.clearTimeId(g),s("#alarmView").children().css({height:"0px",marginTop:"100px"}),s("hr[class='sizeline']").css("marginTop",101-parseInt(I.RectangleAreas[m].TargetSize)),g=setInterval(function(){var e=m,i={};if(c.clearTimeId(p),Utils.LAPI_GetCfgData(LAPI_URL.MotionActivity+"/"+e,i)){var t=i.Activity;u.splice(0,L);for(var a=i.SampleNum,n=0==a?0:Math.max(a,L)/Math.min(a,L),r=0,o=1;r<L;r++){var l={},s=0,d=0;0<a&&(a<L?r==(e=Math.round(n*(o-1)))&&(s=t[o-1].Activity,d=t[o-1].AlarmOn,o++):(s=t[e=Math.round(n*r)].Activity,d=t[e].AlarmOn)),l.Activity=s,l.AlarmOn=d,u.push(l)}f=0,p=setInterval(function(){c.drawMotionActivity()},40)}else c.clearTimeId(g)},1e3)},drawMotionActivity:function(){var e=u[f=L==f?0:f].Activity,i="<div class='activity' style='height: "+e+"px;margin-top: "+(100-e)+"px;background-color: "+(1==u[f].AlarmOn?"red":"gray")+"'></div>",e=s("#alarmView");300==e.children().length&&e.find(":first-child").remove(),e.append(i),f++},addArea:function(){for(var e,i,t=0;t<A&&!s("#areaTR"+t).is(":hidden");t++);t!=A?((e=I.RectangleAreas[t]).Enabled=1,i=e.Area,this.submitF(!0)&&((e=b[h][t]).Left=Number(i.TopLeft.X),e.Top=Number(i.TopLeft.Y),e.Right=Number(i.BottomRight.X),e.Bottom=Number(i.BottomRight.Y),Utils.setDrawObj(h,t,b),Utils.showHiddenArea(h,t,1),s("#areaTR"+t).removeClass("hidden"),this.selectArea(t),this.clickMotionAreaLink())):Frame.showMsg(!0,s.lang.tip.tipUpperMotionInfo,0)},removeArea:function(e){if(I.RectangleAreas[e].Enabled=0,s("#MotionPresetNum").val(-1),this.submitF(!0)){if(e==m&&null!=m){m=null;for(var i=0;i<A;i++)if(1==I.RectangleAreas[i].Enabled){this.selectArea(i);break}}for(var t in r)this.setSliderEnable(t,!1);if(null==m){for(t in s("#areaName").html(""),s("#Sensitivity").val(1),s("#TargetSize").val(1),this.setSliderValue(),r)this.setSliderEnable(t,!0);this.clearTimeId(p),this.clearTimeId(g),s("#alarmView").children().css({height:"0px",marginTop:"100px"})}s("#areaTR"+e).addClass("hidden"),Utils.showHiddenArea(h,e,0),this.clickMotionAreaLink()}},initAreaList:function(){for(var e=I.RectangleAreas,i=0;i<A;i++){var t=e[i],a=s.lang.pub.area,a="<tr id='areaTR"+i+"' class='"+(1==t.Enabled?"":"hidden")+"'><td onclick='Config.alarmMotion.selectArea("+i+");' ><div id='selectDiv"+i+"' class='unselectDiv'><div class='colorDiv' style='background-color: #"+v[i]+"'></div></div></td><td onclick='Config.alarmMotion.selectArea("+i+");' >"+a+(i+1)+"</td><td align='right'><a class='icon black-del' onclick='Config.alarmMotion.removeArea("+i+");this.blur();' title='"+s.lang.pub.del+"'></a></td></tr>";s("#areaTbl").append(a)}},generalPresetOption:function(){var e;s("#MotionPresetNum").is(":visible")&&(e=s("#position").html(),s("#MotionPresetNum").html(e))},setRenderScale:function(){Video.setRenderScale(StreamType.LIVE,0)},detectType_change:function(){var e,i,t=0,a=!1,n=I.RectangleAreas;if(0==(c=Number(s("#Type").val()))){for(s("#areaTblDiv").removeClass("hidden"),s("#areaType").removeClass("hidden"),s("#areaName").removeClass("hidden"),s("#settingsDiv").removeClass("sectionDiv").addClass("areaInfo panel"),s("#alarmViewLi").removeClass("hidden"),s("#TargetSizeLi").removeClass("hidden"),Utils.showHiddenArea(DrawType.RECT_DIAMOND,0,t),e=0;e<A;e++)t=0,1==n[e].Enabled&&(t=1,a||(this.selectArea(e),a=!0)),Utils.showHiddenArea(h,e,t);if(a)this.clickMotionAreaLink();else for(i in s("#Sensitivity").val(1),s("#TargetSize").val(1),this.setSliderValue(),r)this.setSliderEnable(i,!0);S.Enabled=0}else{for(s("#areaTblDiv").addClass("hidden"),s("#areaType").addClass("hidden"),s("#areaName").addClass("hidden"),s("#settingsDiv").removeClass().addClass("sectionDiv"),s("#alarmViewLi").addClass("hidden"),s("#TargetSizeLi").addClass("hidden"),e=0;e<A;e++)Utils.showHiddenArea(h,e,t);for(i in t=1,Utils.showHiddenArea(DrawType.RECT_DIAMOND,0,t),Utils.selectDrawObj(DrawType.RECT_DIAMOND,0),Utils.LAPI_CfgToForm("frmSetup",S),r)this.setSliderEnable(i,!1);this.setSliderValue(),S.Enabled=1}LoginType.VM_LOGIN!=Frame.loginType&&Plan.init(LAPI_URL.WeekPlan+"MotionDetect")},initMotionArea:function(){var e,i,t,a,n=this,r=LANG_TYPE.Chinese==top.language?s.lang.pub.area:"area",o=I.RectangleAreas;for((b={})[h]=[],i=0;i<A;i++)t=(a=o[i].Area).TopLeft,a=a.BottomRight,(e={}).Text=r+(i+1),e.Left=Number(t.X),e.Top=Number(t.Y),e.Right=Number(a.X),e.Bottom=Number(a.Y),e.LineColor=Utils.getDrawObjColor(v[i]),e.LineWidth=2,b[h].push(e);b[DrawType.RECT_DIAMOND]=[],(e={DiamondLengthNum:22,DiamondHeightNum:18}).Diamond=this.decodeData(S.Grid),e.LineColor=Utils.getDrawObjColor("FF0000"),e.LineWidth=1,b[DrawType.RECT_DIAMOND].push(e),Utils.initDrawObj(b,function(){n.detectType_change()})},eventDrawObjParam:function(e,i,t){var a,n=I.RectangleAreas[i].Area,r=n.TopLeft,n=n.BottomRight,o={},l=b[e][i];for(a in isOldPlugin&&!Capinfo.isMac?Utils.sdkAddCfg(o,t):Capinfo.isNoPlugin||(o=s.parseJSON(t)),o)l[a]=o[a];DrawType.RECT==e?(r.X=Math.round(l.Left),r.Y=Math.round(l.Top),n.X=Math.round(l.Right),n.Y=Math.round(l.Bottom)):DrawType.RECT_DIAMOND==e&&(Capinfo.isNoPlugin?S.Grid=this.encodeData(t.Diamond):S.Grid=this.encodeData(l.Diamond)),this.submitF(!0)},eventSelDrawObj:function(e,i){DrawType.RECT==e&&this.selectArea(i)},initVideo_callback:function(e){Utils.EnableDrawFun(e,1),Video.cur_scale=UIRenderScale.FULL,Config.alarmMotion.setRenderScale(),Config.alarmMotion.initMotionArea()},initValidator:function(){s("#IntervalTime").attr("tip",s.validator.format(s.lang.tip.tipIntRange,5,3600)),s("#Dejitter").attr("tip",s.validator.format(s.lang.tip.tipIntRange,1,600)),s("#MotionAreaLinkTime").attr("tip",s.validator.format(s.lang.tip.tipIntRange,1,300)),(o=s("#frmSetup").validate({focusInvalid:!1,errorElement:"span",errorPlacement:function(e,i){Utils.showJqueryErr(e,i,"span")},success:function(e){},rules:{IntervalTime:{integer:!0,required:!0,range:[5,3600]},Dejitter:{integer:!0,required:!0,range:[1,600]},MotionAreaLinkTime:{integer:!0,required:!0,range:[1,300]}}})).init()}}))}(jQuery),Frame.currentNameSpace=Config.alarmMotion;