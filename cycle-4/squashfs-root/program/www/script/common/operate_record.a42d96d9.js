Utils.$package("OperateRecord"),OperateRecord=function(u){var s,g={},p=[],m=[],h=0,D=!1,S=["IsSelect:radio","rowNum:label","StartTime:label","EndTime:label"];return new(Class.extend({init:function(){Utils.beforeDataLoad(),u(document.getElementById("popwin_btnbar")).children().first().find("input").val(u.lang.pub.download),u(document.getElementById("popwin_btnbar")).children().last().remove(),Utils.initLang(),this.initPage(),this.initEvent(),Utils.afterDataLoad()},initPage:function(){Video.sdk_viewer.isInstalled&&u("#recordCfgDiv").removeClass("hidden");var e=new Date,t=e.getFullYear(),n=(n=e.getMonth()+1)<10?"0"+n:n,e=(e=e.getDate())<10?"0"+e:e;u("#openFolder").parent().addClass("hidden"),u("#StartTime").val(t+"-"+n+"-"+e),u("#EndTime").val(t+"-"+n+"-"+e),u("#StartYear").val(t),u("#EndYear").val(t),u("#StartMonth").val(n),u("#EndMonth").val(n),u("#StartDay").val(e),u("#EndDay").val(e)},initData:function(){},initEvent:function(){var e=this;u("#msgObj #download").bind("click",function(){e.downloadRecord()}),u("#recordSearch").bind("click",function(){e.searchRecord()})},submitF:function(){},release:function(){Frame.openWinNameSpace=""},parseDataMapToList:function(e){for(var t,n,a,o={},i=e.Total,r=0;r<i;r++)o=[],a=new Date(1e3*e.RecordInfos[r].Begin),t=new Date(1e3*e.RecordInfos[r].End),o.StartYear=a.getFullYear(),n=a.getMonth()+1,o.StartMonth=n<10?"0"+n:n,o.StartMonthDay=a.getDate()<10?"0"+a.getDate():a.getDate(),o.StartHour=a.getHours()<10?"0"+a.getHours():a.getHours(),o.StartMinute=a.getMinutes()<10?"0"+a.getMinutes():a.getMinutes(),o.StartSecond=a.getSeconds()<10?"0"+a.getSeconds():a.getSeconds(),o.EndYear=t.getFullYear(),a=t.getMonth()+1,o.EndMonth=a<10?"0"+a:a,o.EndMonthDay=t.getDate()<10?"0"+t.getDate():t.getDate(),o.EndHour=t.getHours()<10?"0"+t.getHours():t.getHours(),o.EndMinute=t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes(),o.EndSecond=t.getSeconds()<10?"0"+t.getSeconds():t.getSeconds(),p.push(o)},createTable:function(e,t){for(var n,a=document.getElementById("recorddataview_tbody"),o=a.rows.length;0<o;o--)a.deleteRow(o-1);for(n=0,o=t.length;n<o;n++)this.createRow("recorddataview_tbody",n,e,t[n])},createRow:function(e,t,n,a){var o=this,e=document.getElementById(e),i=document.createElement("tr");i.setAttribute("id","tr"+t),i.onclick=function(){o.selectTR(this.id)};for(var r=0,d=n.length;r<d;r++){var l=document.createElement("td"),c=n[r].split(":"),s=c[0],u=c[1],c=null;"radio"==u?((c=document.createElement("input")).setAttribute("type",u),c.setAttribute("id","chk"+t),c.setAttribute("name","chk"),c.onclick=function(e){e&&e.stopPropagation?e.stopPropagation():window.event.cancelBubble=!0}):"label"==u&&(c=document.createElement(u),u="","StartTime"==s?u=a.StartYear+"-"+a.StartMonth+"-"+a.StartMonthDay+" "+a.StartHour+":"+a.StartMinute+":"+a.StartSecond:"EndTime"==s?u=a.EndYear+"-"+a.EndMonth+"-"+a.EndMonthDay+" "+a.EndHour+":"+a.EndMinute+":"+a.EndSecond:"rowNum"==s&&(u=t+1),c.innerHTML=u),l.appendChild(c),i.appendChild(l)}e.appendChild(i)},selectTR:function(e){e=e.replace("tr",""),e=document.getElementById("chk"+e);e.checked=!e.checked},downloadRecord:function(){m=[];for(var e,t=0,n=document.getElementById("recorddataview_tbody"),a=0;a<n.rows.length;a++)document.getElementById("chk"+a).checked&&(t++,(e={}).index=a,m.push(e));0!=t?(u(document.getElementById("bgObj")).css("z-index",1004),h=0,this.download()):alert(u.lang.tip.tipSelectRecord)},download:function(){var e=m[h].index,t=new Date(1e3*g.RecordInfos[e].Begin),n=new Date(1e3*g.RecordInfos[e].End),a=t.getMonth()+1,o=t.getHours(),i=t.getSeconds(),r=n.getMonth()+1,d=n.getHours(),e=n.getSeconds(),l=String(t.getFullYear())+String(a<10?"0"+a:a)+String(t.getDate()<10?"0"+t.getDate():t.getDate())+String(o<10?"0"+o:o)+String(t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes())+String(i<10?"0"+i:i),c=String(n.getFullYear())+String(r<10?"0"+r:r)+String(n.getDate()<10?"0"+n.getDate():n.getDate())+String(d<10?"0"+d:d)+String(n.getMinutes()<10?"0"+n.getMinutes():n.getMinutes())+String(e<10?"0"+e:e);s=LAPI_URL.RecordDownload+Frame.loginServerIp+"_"+l+"_"+c+".ts?t="+(new Date).getTime(),D=!1,this.stateSearch(u("#recordCfgPath").val())},stateSearch:function(e){var t,n={},a=(u("#statusInfo"),this);Utils.LAPI_GetCfgData(LAPI_URL.RecordDownloadState,n,"",!1)&&(t=n.DownloadState,DownloadResult.DOWNLOAD_SUCCEED==t?D?(n=(n=encodeURI(s)).split("/")[n.split("/").length-1].split("?t=")[0].split("&t=")[0].replace(/\//g,"\\"),Frame.showMsg(!0,u.lang.tip.tipFileDownloadSuccess.replace("%s",decodeURIComponent(n))),Frame.updateBlock(!1)):(setTimeout(function(){Utils.downloadFile(s,e,0,!1,1)},4e3),Frame.updateBlock(!0,u.lang.tip.tipDownloading),u(".blockOverlay").css("z-index",1004),D=!0,setTimeout(function(){a.stateSearch(e)},5e3)):DownloadResult.RECORD_DOWNLOADING==t?(D||(Frame.updateBlock(!0,u.lang.tip.tipDownloading),u(".blockOverlay").css("z-index",1004)),D=!0,setTimeout(function(){a.stateSearch(e)},5e3)):DownloadResult.RECORD_SEND_NUMOUT==t?D?(Frame.updateBlock(!1),Frame.showMsg(!1,u.lang.tip.tipRecordSendFailure)):(setTimeout(function(){Utils.downloadFile(s,e,0,!1,1)},4e3),Frame.updateBlock(!0,u.lang.tip.tipDownloading),u(".blockOverlay").css("z-index",1004),D=!0,setTimeout(function(){a.stateSearch(e)},5e3)):DownloadResult.RECORD_READ_FAIL==t?(D&&Frame.updateBlock(!1),Frame.showMsg(!1,u.lang.tip.tipReadFailure)):DownloadResult.RECORD_CANCEL_DOWNLOAD==t?D?Frame.updateBlock(!1):(setTimeout(function(){Utils.downloadFile(s,e,0,!1,1)},4e3),Frame.updateBlock(!0,u.lang.tip.tipDownloading),u(".blockOverlay").css("z-index",1004),D=!0,setTimeout(function(){a.stateSearch(e)},5e3)):DownloadResult.RECORD_COMMON_FAIL==t?(D&&Frame.updateBlock(!1),Frame.showMsg(!1,u.lang.tip.tipRunFailure)):D?(Frame.updateBlock(!1),Frame.showMsg(!1,u.lang.tip.tipDownloadFailue)):(setTimeout(function(){Utils.downloadFile(s,e,0,!1,1)},4e3),Frame.updateBlock(!0,u.lang.tip.tipDownloading),u(".blockOverlay").css("z-index",1004),D=!0,setTimeout(function(){a.stateSearch(e)},5e3)))},searchRecord:function(){p=[];var e,t,n,a,o={},i={},r=[],d=0,l=0,c=u("#StartTime").val().split("-"),s=u("#EndTime").val().split("-");u("#StartYear").val(c[0]),u("#StartMonth").val(c[1]),u("#StartDay").val(c[2]),u("#EndYear").val(s[0]),u("#EndMonth").val(s[1]),u("#EndDay").val(s[2]),Utils.LAPI_GetCfgData(LAPI_URL.SystemTime,i)&&(e=i.TimeZone,Math.abs(e)),Utils.LAPI_GetCfgData(LAPI_URL.DST_Cfg,o),n=new Date(c[0],c[1]-1,c[2],0,0,0).getTime()/1e3,a=new Date(s[0],s[1]-1,s[2],23,59,59).getTime()/1e3;do{if(!Utils.LAPI_GetCfgData(LAPI_URL.RecordSearch+n+"&End="+a+"&Limit=100&Offset="+d,g))return void Utils.disableAll()}while(t=g.Nums,l=g.Total,d+=t,r=r.concat(g.RecordInfos),g={},d<l);g.Total=l,g.RecordInfos=r,this.parseDataMapToList(g),this.createTable(S,p)},pickerTime:function(){WdatePicker({skin:"whyGreen",dateFmt:"yyyy-MM-dd",lang:top.wdateLang,readOnly:!0})},submitWinData:function(){u("#recordCfgDiv").hasClass("hidden")||""!=u("#recordCfgPath").val()?this.downloadRecord():alert(u.lang.tip.tipInvalidFileErr)}}))}(jQuery),Frame.openWinNameSpace=OperateRecord;