Utils.$package("Plan");var disarmColor="#fff",defenceColor="#58C8EA",textColor="#000",redTextColor="red",timeTextFont="12px Arial",weekTextFont="12px 'Microsoft YaHei'",lineColor="#959595",areaBorderColor="#CCDB33",leftWidth=50,leftHeight=20,Width=18,Height=25,canvasWidth=500,canvasHeight=200,PLANNUM=4,WeekArray=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],isForCanvas=!0,isPainting=!1,isMouseDown=!1,StartX=0,StartY=0,EndX=0,EndY=0,context=null,planMode=-1,PlanJsonMap={},PlanStatusMap={},PlanDataList=[],PlanDataList_bak=[],planMap={},color=disarmColor,docMouseSelectEvent=document.onselectstart;Plan.PaintPlanTemplate=function(){var a=document.getElementById("canvas");(a=!isForCanvas?G_vmlCanvasManager.initElement(a):a)&&((context=a.getContext("2d")).fillRect(leftWidth,leftHeight,canvasWidth,canvasHeight),Plan.PaintPlanData(),Plan.PaintPlanBorder())},Plan.PaintWeek=function(){var a,n;for(context.fillStyle=textColor,context.font=timeTextFont,context.lineWidth=1,a=0;a<=24;a++)context.fillText(a,leftWidth-5+Width*a,leftHeight-5);for(context.font=weekTextFont,n=WeekArray.length,a=0;a<n;a++)5==a&&(context.fillStyle=redTextColor),context.fillText($.lang.pub[WeekArray[a]],leftWidth-40,leftHeight+15+Height*a)},Plan.PaintPlanBorder=function(){var a,n,t=0;for(context.strokeStyle=lineColor,context.lineWidth=1,n=WeekArray.length,a=0;a<24;a++)for(t=0;t<n;t++)context.strokeRect(leftWidth+Width*a+.5,leftHeight+Height*t+.5,Width,Height)},Plan.changeTimeStrToH=function(a){var n=0;return""!=a&&(a=a.split(":"),n=3600*Number(a[0])+60*Number(a[1])+Number(a[2])),n/3600},Plan.sortFun=function(a,n){return a.PlanStartTime==n.PlanStartTime?0:""==a.PlanStartTime||a.PlanStartTime>n.PlanStartTime&&""!=n.PlanStartTime?1:-1},Plan.TimeArraySort=function(){for(var a=WeekArray.length,n=0;n<a;n++)PlanDataList[n].sort(Plan.sortFun)},Plan.getIndex=function(a,n){for(var t,e,l=0,i=a.length,r=-1;l<i&&-1==r;l++)t=a[l].PlanStartTime,e=a[l].PlanEndTime,n<t?(0==l||n>a[l-1].PlanEndTime)&&(r=l-.5):t<=n&&n<=e?r=l:(l==i-1||n<a[l+1].PlanStartTime)&&(r=l+.5);return r},Plan.MergeArray=function(a){for(var n,t,e,l,i,r=0,o=0,P=a.length,s=0,d=[],c={},o=0;o<P;o++)if("undefined"!=typeof a[o]){if(n=a[o].PlanStartTime,"24:00:00"==(s=a[o].PlanEndTime)&&(s="23:59:59"),t=[],$.extend(t,PlanDataList[o]),d=[],l=Plan.getIndex(t,n),i=Plan.getIndex(t,s),e=t.length,0==planMode){for(r=0;r<l;r++)"00:00:00"==t[r].PlanStartTime&&"00:00:00"==t[r].PlanEndTime||""==t[r].PlanStartTime&&""==t[r].PlanEndTime||d.push(t[r]);if(r<e)for((c={}).PlanStartTime=t[r].PlanStartTime>n?n:t[r].PlanStartTime,r=i-parseInt(i,10)==0?(c.PlanEndTime=t[i].PlanEndTime,i+1):(c.PlanEndTime=s,i+.5),d.push(c);r<e&&!("00:00:00"==t[r].PlanStartTime&&"00:00:00"==t[r].PlanEndTime||""==t[r].PlanStartTime&&""==t[r].PlanEndTime);r++)d.push(t[r]);else(c={}).PlanStartTime=n,c.PlanEndTime=s,d.push(c)}else if(1==planMode){for(r=0;r<l;r++)"00:00:00"==t[r].PlanStartTime&&"00:00:00"==t[r].PlanEndTime||""==t[r].PlanStartTime&&""==t[r].PlanEndTime||d.push(t[r]);if(r<e)for(t[r].PlanStartTime<n&&((c={}).PlanStartTime=t[r].PlanStartTime,c.PlanEndTime=n,d.push(c)),r=i-parseInt(i,10)==0?(t[i].PlanEndTime>s&&((c={}).PlanStartTime=s,c.PlanEndTime=t[i].PlanEndTime,d.push(c)),i+1):i+.5;r<e&&!("00:00:00"==t[r].PlanStartTime&&"00:00:00"==t[r].PlanEndTime||""==t[r].PlanStartTime&&""==t[r].PlanEndTime);r++)d.push(t[r])}if(d.length>PLANNUM)return Plan.PaintPlanData(),Plan.PaintPlanBorder(),Plan.PaintAreaBorder(),alert($.lang.tip.tipTimeSectionLimit.replace("%s1",$.lang.pub[WeekArray[o]]).replace("%s2",PLANNUM)),!1;if(d.length<PLANNUM)for(r=d.length;r<PLANNUM;r++)d.push(c={PlanStartTime:"",PlanEndTime:""});PlanDataList[o]=d}},Plan.PaintPlanData=function(){var a,n,t,e,l=WeekArray.length,i=0;for(context.clearRect(0,0,canvasWidth,canvasHeight),Plan.PaintWeek(),a=0;a<l;a++)for(e=PlanDataList[a],i=0;i<PLANNUM;i++)(n=Plan.changeTimeStrToH(e[i].PlanStartTime)*Width)!=(t=Plan.changeTimeStrToH(e[i].PlanEndTime)*Width)&&(context.fillStyle=defenceColor,context.fillRect(leftWidth+n,leftHeight+a*Height,t-n,Height))},Plan.updatePlanData=function(){var a=[],n=0,t={};for(Plan.TimeArraySort(),n=Math.min(StartY,EndY);n<=Math.max(StartY,EndY);n++)(t={}).PlanStartTime=Math.min(StartX,EndX)+":00:00",t.PlanEndTime=Math.max(StartX,EndX)+1+":00:00",7==t.PlanStartTime.length&&(t.PlanStartTime="0"+t.PlanStartTime),7==t.PlanEndTime.length&&(t.PlanEndTime="0"+t.PlanEndTime),"24:00:00"==t.PlanEndTime.length&&(t.PlanEndTime="23:59:59"),a[n]=t;Plan.MergeArray(a)},Plan.redraw=function(){var a,n,t,e,l,i,r;(-1!=StartX&&24!=StartX&&-1!=StartY&&7!=StartY||-1!=EndX&&24!=EndX&&-1!=EndY&&7!=EndY)&&(Plan.PaintPlanData(),context.fillStyle=color,0<(e=Plan.formatX(StartX))+(i=Plan.formatX(EndX))+(l=Plan.formatY(StartY))+(r=Plan.formatY(EndY))&&(a=Math.min(e,i),n=Math.min(l,r),t=Math.max(e,i)-a+1,Ylength=Math.max(l,r)-n+1,a=a*Width+leftWidth,n=n*Height+leftHeight,context.lineWidth=1,context.fillRect(a,n,Width*t,Height*Ylength)),Plan.PaintPlanBorder(),Plan.PaintAreaBorder())},Plan.PaintAreaBorder=function(){isForCanvas&&isPainting&&(context.strokeStyle=areaBorderColor,context.lineWidth=3,context.strokeRect(leftWidth-2,leftHeight-2,24*Width+4,7*Height+4))},Plan.getStartPoint=function(a,n){a=Plan.repairX(a),n=Plan.repairY(n),EndX=StartX=a,EndY=StartY=n},Plan.getEndPoint=function(a,n){a=Plan.repairX(a),n=Plan.repairY(n),EndX==a&&EndY==n||(EndX=a,EndY=n,Plan.redraw())},Plan.repairX=function(a){return a=(a=(a-leftWidth)/Width)<0?-1:24<a?24:Math.floor(a)},Plan.repairY=function(a){return a=(a=(a-leftHeight)/Height)<0?-1:7<a?7:Math.floor(a)},Plan.formatX=function(a){return-1==a?a=0:24==a&&(a=23),a},Plan.formatY=function(a){return-1==a?a=0:7==a&&(a=6),a},Plan.cloneDayData=function(a,n){PlanDataList[n]=Utils.objectClone(PlanDataList[a])},Plan.repareData=function(a){var n=0,t=a.length,e=0,l=0;for(a.sort(Plan.sortFun),n=0;n<t-1;n++)""!=(e=a[n].PlanEndTime)&&(timeArr=e.split(":"),e=3600*Number(timeArr[0])+60*Number(timeArr[1])+Number(timeArr[2]),l=a[n+1].PlanStartTime,timeArr=l.split(":"),(l=3600*Number(timeArr[0])+60*Number(timeArr[1])+Number(timeArr[2]))-e<=1&&(a[n].PlanEndTime=a[n+1].PlanEndTime,a.splice(n+1,1),a.push({PlanStartTime:"",PlanEndTime:""}),n--))},Plan.initPage=function(a){var n="",a=a||$.lang.pub.enablePlan;"undefined"!=typeof G_vmlCanvasManager&&(isForCanvas=!1,n="hidden");a="<fieldset><legend class='textCell'><input type='checkbox' id='PlanEnable' name='PlanEnable' checked= ''/><label for='PlanEnable'>"+a+"</label></legend><div class='editBtnDiv' style='width: "+canvasWidth+"px;height: 24px'><span class='button right' id='editPlan' data-create='1'><span class='btn_l'></span><button type='button' class='submit_btn'>"+$.lang.pub.modify+"</button><span class='btn_r'></span></span><span class='button "+n+"' id='defence' data-create='1'><span class='btn_l'></span><button type='button' class='submit_btn buttonTextLeft'><div class='plan_colorDiv defence'></div>"+$.lang.pub.defence+"</button><span class='btn_r'></span></span><span class='button "+n+"' id='disarm' data-create='1'><span class='btn_l'></span><button type='button' class='submit_btn buttonTextLeft'><div class='plan_colorDiv disarm'></div>"+$.lang.pub.disarm+"</button><span class='btn_r'></span></span></div><div class='planContent' id='planContent'></div></fieldset>",n=$("#planDiv");n.html(""),n.append(a);a=document.createElement("canvas");$(a).attr({width:canvasWidth,height:canvasHeight,id:"canvas"}),$(a).css("position","relative"),$("#planContent").append(a)},Plan.IsChanged=function(){var a=$("#PlanEnable").is(":checked")?1:0;return!Utils.isObjectEquals(PlanDataList,PlanDataList_bak)||planMap.PlanEnable!=a},Plan.initData=function(a){var n,t,e,l,i,r=0,o=0;if(!Utils.LAPI_GetCfgData(a,PlanJsonMap))return Utils.disableAll(),!1;for(PlanDataList=[],r=0,n=Number(PlanJsonMap.DayNum);r<n;r++){for(t=[],e=PlanJsonMap.Day[(r+1)%7],o=0;o<PLANNUM;o++)i=e.TimeSection[o],(l={}).PlanStartTime=i.Begin,l.PlanEndTime=i.End,"24:00:00"==l.PlanStartTime&&(l.PlanStartTime=""),"24:00:00"==l.PlanEndTime&&(l.PlanEndTime=""),t.push(l);Plan.repareData(t),PlanDataList.push(t)}if(PlanDataList_bak=Utils.objectClone(PlanDataList),"undefined"==typeof Frame.currentNameSpace.parkType){if(!Utils.LAPI_GetCfgData(a.replace("WeekPlan","WeekPlanStatus"),PlanStatusMap))return Utils.disableAll(),!1;planMap.PlanEnable=PlanStatusMap.Enable,$("#PlanEnable").prop("checked",1==planMap.PlanEnable)}},Plan.submitF=function(a){for(var n,t,e,l,i,r,o=0,P=0,s=WeekArray.length,d=$("#PlanEnable"),o=0;o<s;o++)for(t=PlanDataList[o],e=PlanJsonMap.Day[(o+1)%7],P=0;P<PLANNUM;P++)l=t[P],i=e.TimeSection[P],""==(r=l.PlanStartTime)&&(r="24:00:00"),i.Begin=r,""==(r=l.PlanEndTime)&&(r="24:00:00"),i.End=r;if((n=Utils.LAPI_SetCfgData(a,PlanJsonMap,!1))&&(PlanDataList_bak=Utils.objectClone(PlanDataList),"undefined"==typeof Frame.currentNameSpace.parkType)){if(r=d.is(":checked")?1:0,PlanStatusMap.Enable=r,!Utils.LAPI_SetCfgData(a.replace("WeekPlan","WeekPlanStatus"),PlanStatusMap))return Utils.disableAll(),!1;planMap.PlanEnable=r}return Frame.showMsg(n),n},Plan.initEvent=function(){var a=$("html");$("#canvas").bind("mousedown",function(a){var n,t;isPainting&&(n=(t=$("#canvas"))[0]?t.offset().left:0,t=t[0]?t.offset().top:0,document.onselectstart=function(){return!1},isMouseDown=!0,Plan.getStartPoint(a.pageX-n,a.pageY-t))}),a.bind("mousemove",function(a){var n,t;isPainting&&isMouseDown&&(n=(t=$("#canvas"))[0]?t.offset().left:0,t=t[0]?t.offset().top:0,Plan.getEndPoint(a.pageX-n,a.pageY-t))}),a.bind("mouseup",function(a){isPainting&&isMouseDown&&(isMouseDown=!1,Plan.redraw(),StartX=Plan.formatX(StartX),EndX=Plan.formatX(EndX),StartY=Plan.formatY(StartY),EndY=Plan.formatY(EndY),Plan.updatePlanData(),document.onselectstart=docMouseSelectEvent)}),$("#editPlan").bind("click",function(){var a=$("#canvas"),a=a[0]?a.offset().left:0;"undefined"!=typeof Frame.currentNameSpace.parkType?Utils.openWin($.lang.pub.modify,"/page/common/week_plan.80954c6f.htm?id=week_plan",535,380,!1,0,250):Utils.openWin($.lang.pub.modify,"/page/common/week_plan.80954c6f.htm?id=week_plan",535,380,!1,a-10,250),EndY=StartY=EndX=StartX=0}),$("#defence").bind("click",function(a){$(".plan_colorDiv_selected").removeClass("plan_colorDiv_selected"),$("div.defence").addClass("plan_colorDiv_selected"),isPainting=!0,planMode=0,color=defenceColor}),$("#disarm").bind("click",function(a){$(".plan_colorDiv_selected").removeClass("plan_colorDiv_selected"),$("div.disarm").addClass("plan_colorDiv_selected"),isPainting=!0,planMode=1,color=disarmColor})},Plan.init=function(a,n){Plan.initPage(n),Plan.initEvent(),Plan.initData(a),Plan.PaintPlanTemplate()};